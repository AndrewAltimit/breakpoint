---
name: Main CI

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release (even without tag)'
        required: false
        type: boolean
        default: false

concurrency:
  group: main-ci-${{ github.sha }}
  cancel-in-progress: false

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ── CI Stages (containerized) ──────────────────────────────────
  ci:
    name: Breakpoint CI
    runs-on: self-hosted
    timeout-minutes: 60
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs web/pkg tests/browser/node_modules tests/browser/results tests/browser/report .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Set UID/GID
        run: |
          echo "USER_ID=$(id -u)" >> $GITHUB_ENV
          echo "GROUP_ID=$(id -g)" >> $GITHUB_ENV

      # ── Formatting ──────────────────────────────────────────────
      - name: Format check
        run: docker compose --profile ci run --rm rust-ci cargo fmt --all -- --check

      # ── Linting ─────────────────────────────────────────────────
      - name: Clippy
        run: docker compose --profile ci run --rm rust-ci cargo clippy --workspace --all-targets -- -D warnings

      # ── Tests ───────────────────────────────────────────────────
      - name: Test
        run: docker compose --profile ci run --rm rust-ci cargo test --workspace

      # ── Build ───────────────────────────────────────────────────
      - name: Build (release)
        run: docker compose --profile ci run --rm rust-ci cargo build --workspace --release

      # ── License / Advisory ──────────────────────────────────────
      - name: cargo-deny
        run: docker compose --profile ci run --rm rust-ci cargo deny check

      # ── WASM Client ──────────────────────────────────────────────
      - name: WASM client build check
        run: |
          docker compose --profile ci run --rm rust-ci \
            wasm-pack build crates/breakpoint-client --target web --out-dir /tmp/wasm-check --dev

      - name: Fix Docker file ownership
        if: always()
        run: |
          for dir in target outputs; do
            if [ -d "$dir" ]; then
              docker run --rm -v "$(pwd)/$dir:/workspace" busybox:1.36.1 \
                chown -Rh "$(id -u):$(id -g)" /workspace 2>/dev/null || true
            fi
          done

  # ── Docker Image ──────────────────────────────────────────────────
  docker:
    name: Docker Image
    needs: ci
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    runs-on: self-hosted
    timeout-minutes: 90
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Determine image tags
        id: tags
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${REPO_LOWER}"
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "tags=${IMAGE}:${VERSION},${IMAGE}:latest" >> $GITHUB_OUTPUT
          else
            SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            echo "tags=${IMAGE}:sha-${SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        run: |
          IFS=',' read -ra TAGS <<< "${{ steps.tags.outputs.tags }}"
          TAG_ARGS=""
          for tag in "${TAGS[@]}"; do
            TAG_ARGS="${TAG_ARGS} -t ${tag}"
          done
          docker build -f docker/server.Dockerfile ${TAG_ARGS} .
          for tag in "${TAGS[@]}"; do
            docker push "${tag}"
          done

  # ── Build Release Artifacts ──────────────────────────────────────
  build-release:
    name: Build Release (${{ matrix.target }})
    needs: ci
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    runs-on: self-hosted
    timeout-minutes: 60
    strategy:
      matrix:
        include:
          - target: linux-x86_64
            arch: x86_64
          - target: linux-aarch64
            arch: aarch64
            cross: true
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs release-artifacts .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Set UID/GID
        run: |
          echo "USER_ID=$(id -u)" >> $GITHUB_ENV
          echo "GROUP_ID=$(id -g)" >> $GITHUB_ENV

      - name: Create output directory
        run: mkdir -p release-artifacts

      - name: Build server + relay binaries (native)
        if: '!matrix.cross'
        run: |
          docker compose --profile ci run --rm rust-ci bash -c "
            set -e
            cargo build --release -p breakpoint-server --features github-poller
            cargo build --release -p breakpoint-relay

            cp target/release/breakpoint-server /app/release-artifacts/breakpoint-server-${{ matrix.target }}
            cp target/release/breakpoint-relay /app/release-artifacts/breakpoint-relay-${{ matrix.target }}
            echo 'Built binaries for ${{ matrix.target }}'
          "

      - name: Build server + relay binaries (cross-compile)
        if: matrix.cross
        run: |
          docker compose --profile ci run --rm rust-ci bash -c "
            set -e
            rustup target add aarch64-unknown-linux-gnu 2>/dev/null || true
            apt-get update -qq && apt-get install -y -qq gcc-aarch64-linux-gnu 2>/dev/null || true
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc

            cargo build --release -p breakpoint-server --features github-poller --target aarch64-unknown-linux-gnu || {
              echo '::warning::Cross-compilation for aarch64 failed — skipping'
              exit 0
            }
            cargo build --release -p breakpoint-relay --target aarch64-unknown-linux-gnu || true

            if [ -f target/aarch64-unknown-linux-gnu/release/breakpoint-server ]; then
              cp target/aarch64-unknown-linux-gnu/release/breakpoint-server /app/release-artifacts/breakpoint-server-${{ matrix.target }}
            fi
            if [ -f target/aarch64-unknown-linux-gnu/release/breakpoint-relay ]; then
              cp target/aarch64-unknown-linux-gnu/release/breakpoint-relay /app/release-artifacts/breakpoint-relay-${{ matrix.target }}
            fi
          "

      - name: Build WASM client
        if: '!matrix.cross'
        run: |
          docker compose --profile ci run --rm rust-ci bash -c "
            set -e
            wasm-pack build crates/breakpoint-client --target web --out-dir /app/release-artifacts/wasm-client
            wasm-opt -Oz --enable-bulk-memory \
              /app/release-artifacts/wasm-client/breakpoint_client_bg.wasm \
              -o /app/release-artifacts/wasm-client/breakpoint_client_bg.wasm
            echo 'Built and optimized WASM client bundle'
          "

      - name: List built artifacts
        run: |
          echo "Built artifacts:"
          ls -la release-artifacts/
          ls -la release-artifacts/wasm-client/ 2>/dev/null || true

      - name: Upload binary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ matrix.target }}
          path: release-artifacts/*
          retention-days: 90

  # ── Create GitHub Release ──────────────────────────────────────
  create-release:
    name: Create GitHub Release
    needs: [ci, build-release, docker]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    runs-on: self-hosted
    timeout-minutes: 20
    permissions:
      contents: write
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs release-artifacts .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-artifacts-*
          path: release-artifacts
          merge-multiple: true

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(date +%Y.%m.%d)-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate changelog from merged PRs
        id: changelog
        run: |
          CURRENT_TAG="${{ steps.version.outputs.version }}"

          # Find the previous release tag for comparison
          PREVIOUS_TAG=$(git tag --sort=-version:refname --list 'v[0-9]*' | grep -Fxv "$CURRENT_TAG" | head -n 1)

          CHANGELOG=""
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog: ${PREVIOUS_TAG}...${CURRENT_TAG}"
            CHANGELOG=$(gh api repos/${{ github.repository }}/releases/generate-notes \
              -f tag_name="$CURRENT_TAG" \
              -f previous_tag_name="$PREVIOUS_TAG" \
              --jq '.body' 2>/dev/null || echo "")
          fi

          if [ -n "$CHANGELOG" ]; then
            printf '%s\n' "$CHANGELOG" > changelog_snippet.md
            echo "has_changelog=true" >> $GITHUB_OUTPUT
            echo "Changelog generated successfully"
          else
            echo "No changelog generated"
            echo "has_changelog=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## Release ${{ steps.version.outputs.version }}

          ### Rust Binaries

          Pre-built binaries for Breakpoint:

          | Binary | Platform | Description |
          |--------|----------|-------------|
          | `breakpoint-server-linux-x86_64` | Linux x64 | Host server binary (Axum + WSS + REST + GitHub poller) |
          | `breakpoint-server-linux-aarch64` | Linux arm64 | Host server binary (cross-compiled) |
          | `breakpoint-relay-linux-x86_64` | Linux x64 | Stateless WS relay for NAT traversal |
          | `breakpoint-relay-linux-aarch64` | Linux arm64 | Stateless WS relay (cross-compiled) |

          ### WASM Client

          Browser client bundle included in release artifacts:

          - **wasm-client/** - Optimized WASM + JS glue for the browser client

          ### Docker Image

          ```bash
          docker run -p 8080:8080 -e BREAKPOINT_API_TOKEN=secret ghcr.io/andrewaltimit/breakpoint:latest
          ```

          ### Installation

          ```bash
          # From binary
          chmod +x breakpoint-server-linux-x86_64 breakpoint-relay-linux-x86_64
          ./breakpoint-server-linux-x86_64
          ```

          ### Commit Information

          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          EOF

          # Append auto-generated changelog if available
          if [ "${{ steps.changelog.outputs.has_changelog }}" = "true" ] && [ -f changelog_snippet.md ]; then
            printf '\n---\n\n' >> release_notes.md
            cat changelog_snippet.md >> release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: release-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ── CI Summary ─────────────────────────────────────────────────
  notify:
    name: CI Summary
    needs: [ci, build-release, docker, create-release]
    if: always()
    runs-on: self-hosted
    steps:
      - name: Generate summary
        run: |
          echo "## Main CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CI | ${{ needs.ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Release | ${{ needs.build-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Image | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.ci.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "CI failed - please review the logs" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Create issue on failure
        if: failure() && github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "Main CI Failed: $(date +%Y-%m-%d)" \
            --body "$(cat <<'ISSUE_EOF'
          ## CI Failure Report

          **Commit**: ${{ github.sha }}
          **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please investigate and fix the issues.
          ISSUE_EOF
          )" \
            --label "ci-failure,automated" || echo "::warning::Could not create failure issue"
