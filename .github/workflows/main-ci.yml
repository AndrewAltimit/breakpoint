---
name: Main CI

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release (even without tag)'
        required: false
        type: boolean
        default: false

concurrency:
  group: main-ci-${{ github.sha }}
  cancel-in-progress: false

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ── CI Stages (containerized) ──────────────────────────────────
  ci:
    name: Breakpoint CI
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Set UID/GID
        run: |
          echo "USER_ID=$(id -u)" >> $GITHUB_ENV
          echo "GROUP_ID=$(id -g)" >> $GITHUB_ENV

      # ── Formatting ──────────────────────────────────────────────
      - name: Format check
        run: docker compose --profile ci run --rm rust-ci cargo fmt --all -- --check

      # ── Linting ─────────────────────────────────────────────────
      - name: Clippy
        run: docker compose --profile ci run --rm rust-ci cargo clippy --workspace --all-targets -- -D warnings

      # ── Tests ───────────────────────────────────────────────────
      - name: Test
        run: docker compose --profile ci run --rm rust-ci cargo test --workspace

      # ── Build ───────────────────────────────────────────────────
      - name: Build (release)
        run: docker compose --profile ci run --rm rust-ci cargo build --workspace --release

      # ── License / Advisory ──────────────────────────────────────
      - name: cargo-deny
        run: docker compose --profile ci run --rm rust-ci cargo deny check

      - name: Fix Docker file ownership
        if: always()
        run: |
          for dir in target outputs; do
            if [ -d "$dir" ]; then
              docker run --rm -v "$(pwd)/$dir:/workspace" busybox:1.36.1 \
                chown -Rh "$(id -u):$(id -g)" /workspace 2>/dev/null || true
            fi
          done

  # ── Build Release Artifacts ──────────────────────────────────────
  build-release:
    name: Build Release Artifacts
    needs: ci
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs release-artifacts .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Set UID/GID
        run: |
          echo "USER_ID=$(id -u)" >> $GITHUB_ENV
          echo "GROUP_ID=$(id -g)" >> $GITHUB_ENV

      - name: Create output directory
        run: mkdir -p release-artifacts

      - name: Build server binary (release)
        run: |
          ARCH=$(uname -m)
          echo "Building breakpoint-server for linux-${ARCH}..."

          docker compose --profile ci run --rm rust-ci bash -c "
            set -e
            cargo build --release -p breakpoint-server

            if [ -f 'target/release/breakpoint-server' ]; then
              cp 'target/release/breakpoint-server' '/app/release-artifacts/breakpoint-server-linux-${ARCH}'
              echo 'Built breakpoint-server for linux-${ARCH}'
            else
              echo 'Error: breakpoint-server binary not found'
              exit 1
            fi
          "

      - name: Build WASM client
        run: |
          docker compose --profile ci run --rm rust-ci bash -c "
            set -e
            wasm-pack build crates/breakpoint-client --target web --out-dir /app/release-artifacts/wasm-client
            echo 'Built WASM client bundle'
          "

      - name: List built artifacts
        run: |
          echo "Built artifacts:"
          ls -la release-artifacts/
          ls -la release-artifacts/wasm-client/ 2>/dev/null || true

      - name: Upload binary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: release-artifacts/*
          retention-days: 90

  # ── Create GitHub Release ──────────────────────────────────────
  create-release:
    name: Create GitHub Release
    needs: [ci, build-release]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    runs-on: self-hosted
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: release-artifacts

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(date +%Y.%m.%d)-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate changelog
        id: changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG="${{ steps.version.outputs.version }}"
          PREVIOUS_TAG=$(git tag --sort=-version:refname --list 'v[0-9]*' | grep -Fxv "$CURRENT_TAG" | head -n 1)

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog: ${PREVIOUS_TAG}...${CURRENT_TAG}"
            CHANGELOG=$(gh api repos/${{ github.repository }}/releases/generate-notes \
              -f tag_name="$CURRENT_TAG" \
              -f previous_tag_name="$PREVIOUS_TAG" \
              --jq '.body' 2>/dev/null || echo "")

            if [ -n "$CHANGELOG" ]; then
              printf '%s\n' "$CHANGELOG" > changelog_snippet.md
              echo "has_changelog=true" >> $GITHUB_OUTPUT
            else
              echo "has_changelog=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_changelog=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        run: |
          cat << 'RELEASE_EOF' > release_notes.md
          ## Release ${{ steps.version.outputs.version }}

          ### Breakpoint

          Office Hours Gaming Platform with Agent Monitoring Overlay.

          | Artifact | Description |
          |----------|-------------|
          | `breakpoint-server-linux-*` | Host server binary (Axum + WSS + REST) |
          | `wasm-client/` | WASM browser client bundle |

          ### Quick Start

          ```bash
          # Make server executable
          chmod +x breakpoint-server-linux-*

          # Run the server
          ./breakpoint-server-linux-x86_64
          ```

          ### Commit Information

          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          RELEASE_EOF

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' release_notes.md

          # Append auto-generated changelog if available
          if [ "${{ steps.changelog.outputs.has_changelog }}" = "true" ] && [ -f changelog_snippet.md ]; then
            printf '\n---\n\n' >> release_notes.md
            cat changelog_snippet.md >> release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: release-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ── CI Summary ─────────────────────────────────────────────────
  notify:
    name: CI Summary
    needs: [ci, build-release, create-release]
    if: always()
    runs-on: self-hosted
    steps:
      - name: Generate summary
        run: |
          echo "## Main CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CI | ${{ needs.ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Release | ${{ needs.build-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.ci.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "CI failed - please review the logs" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Create issue on failure
        if: failure() && github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "Main CI Failed: $(date +%Y-%m-%d)" \
            --body "$(cat <<'ISSUE_EOF'
          ## CI Failure Report

          **Commit**: ${{ github.sha }}
          **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please investigate and fix the issues.
          ISSUE_EOF
          )" \
            --label "ci-failure,automated" || echo "::warning::Could not create failure issue"
