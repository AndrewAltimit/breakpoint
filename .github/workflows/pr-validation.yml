---
name: Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: pr-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ── Feature Flags ───────────────────────────────────────────
  config:
    name: Configuration
    runs-on: ubuntu-latest
    outputs:
      ai-reviews-enabled: 'false'  # Set to 'true' to enable AI reviews
    steps:
      - run: echo "AI reviews disabled for initial release"

  # Fork guard: block fork PRs from running on self-hosted runners with write perms
  fork-guard:
    name: Fork PR Guard
    runs-on: ubuntu-latest
    if: >-
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - run: echo "Not a fork PR - proceeding"

  # ── CI Stages (containerized) ──────────────────────────────────
  ci:
    name: Breakpoint CI
    needs: fork-guard
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Set UID/GID
        run: |
          echo "USER_ID=$(id -u)" >> $GITHUB_ENV
          echo "GROUP_ID=$(id -g)" >> $GITHUB_ENV

      # ── Formatting ──────────────────────────────────────────────
      - name: Format check
        run: docker compose --profile ci run --rm rust-ci cargo fmt --all -- --check

      # ── Linting ─────────────────────────────────────────────────
      - name: Clippy
        run: docker compose --profile ci run --rm rust-ci cargo clippy --workspace --all-targets -- -D warnings

      # ── Tests ───────────────────────────────────────────────────
      - name: Test
        run: docker compose --profile ci run --rm rust-ci cargo test --workspace

      # ── Build ───────────────────────────────────────────────────
      - name: Build (release)
        run: docker compose --profile ci run --rm rust-ci cargo build --workspace --release

      # ── License / Advisory ──────────────────────────────────────
      - name: cargo-deny
        run: docker compose --profile ci run --rm rust-ci cargo deny check

      # ── WASM Client ──────────────────────────────────────────────
      - name: WASM client build check
        run: |
          docker compose --profile ci run --rm rust-ci \
            wasm-pack build crates/breakpoint-client --target web --out-dir /tmp/wasm-check --dev

      - name: Fix Docker file ownership
        if: always()
        run: |
          for dir in target outputs; do
            if [ -d "$dir" ]; then
              docker run --rm -v "$(pwd)/$dir:/workspace" busybox:1.36.1 \
                chown -Rh "$(id -u):$(id -g)" /workspace 2>/dev/null || true
            fi
          done

  # ── Browser Tests (Playwright, containerized) ─────────────────
  browser-tests:
    name: Browser Tests
    needs: ci
    runs-on: self-hosted
    timeout-minutes: 30
    continue-on-error: true
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Set UID/GID
        run: |
          echo "USER_ID=$(id -u)" >> $GITHUB_ENV
          echo "GROUP_ID=$(id -g)" >> $GITHUB_ENV

      - name: Build CI images
        run: docker compose --profile ci build

      - name: Build server (release)
        run: docker compose --profile ci run --rm rust-ci cargo build -p breakpoint-server --release

      - name: Build WASM client
        run: |
          docker compose --profile ci run --rm rust-ci \
            wasm-pack build crates/breakpoint-client --target web --out-dir ../../web/pkg --dev

      - name: Fix Docker file ownership
        run: |
          for dir in target web/pkg; do
            if [ -d "$dir" ]; then
              docker run --rm -v "$(pwd)/$dir:/workspace" busybox:1.36.1 \
                chown -Rh "$(id -u):$(id -g)" /workspace 2>/dev/null || true
            fi
          done

      - name: Start server
        run: |
          ./target/release/breakpoint-server &
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8080/health > /dev/null 2>&1; then
              echo "Server ready"
              break
            fi
            sleep 0.5
          done

      - name: Run Playwright tests
        run: |
          docker compose --profile ci run --rm playwright \
            bash -c "npm ci && npx playwright test --project=chromium --reporter=list"
        timeout-minutes: 20

      - name: Stop server
        if: always()
        run: pkill -f breakpoint-server || true

      - name: Fix test output ownership
        if: always()
        run: |
          for dir in tests/browser/results tests/browser/report tests/browser/node_modules; do
            if [ -d "$dir" ]; then
              docker run --rm -v "$(pwd)/$dir:/workspace" busybox:1.36.1 \
                chown -Rh "$(id -u):$(id -g)" /workspace 2>/dev/null || true
            fi
          done

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ github.run_id }}
          path: |
            tests/browser/results/
            tests/browser/report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Fix Docker file ownership
        if: always()
        run: |
          for dir in target outputs; do
            if [ -d "$dir" ]; then
              docker run --rm -v "$(pwd)/$dir:/workspace" busybox:1.36.1 \
                chown -Rh "$(id -u):$(id -g)" /workspace 2>/dev/null || true
            fi
          done

  # ── Gemini AI Code Review ──────────────────────────────────────
  gemini-review:
    name: Gemini AI Code Review
    needs: [fork-guard, config]
    if: >-
      needs.config.outputs.ai-reviews-enabled == 'true' &&
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft
    runs-on: self-hosted
    timeout-minutes: 30
    outputs:
      status: ${{ steps.review.outputs.status }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Log commit info
        id: check-agent
        run: |
          LAST_AUTHOR=$(git log -1 --format='%an')
          echo "Last commit author: $LAST_AUTHOR"
          IS_AGENT="false"
          if [[ "$LAST_AUTHOR" == "AI Review Agent" ]] || \
             [[ "$LAST_AUTHOR" == "AI Pipeline Agent" ]] || \
             [[ "$LAST_AUTHOR" == "AI Agent Bot" ]]; then
            IS_AGENT="true"
          fi
          echo "is_agent_commit=$IS_AGENT" >> $GITHUB_OUTPUT

      - name: Run Gemini review
        id: review
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if ! command -v github-agents &>/dev/null; then
            echo "::warning::github-agents not found on PATH - skipping Gemini review"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          set +e
          OUTPUT=$(github-agents pr-review "$PR_NUMBER" --editor 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT"
          echo "$OUTPUT" > gemini-review.md

          if [ $EXIT_CODE -ne 0 ]; then
            if echo "$OUTPUT" | grep -qiE '429|rate.?limit|quota|resource.?exhausted'; then
              echo "::warning::Gemini API rate limit hit - skipping review"
              echo "status=rate_limited" >> $GITHUB_OUTPUT
              exit 0
            elif echo "$OUTPUT" | grep -qiE '503|502|service.?unavailable|ECONNREFUSED|ETIMEDOUT'; then
              echo "::warning::Gemini API unavailable - skipping review"
              echo "status=unavailable" >> $GITHUB_OUTPUT
              exit 0
            elif echo "$OUTPUT" | grep -qiE 'panicked at|thread.*panic'; then
              echo "::warning::Gemini review tool crashed - skipping review"
              echo "status=tool_crash" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              exit $EXIT_CODE
            fi
          fi

          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload review artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gemini-review-${{ github.run_id }}-${{ github.run_attempt }}
          path: gemini-review.md
          retention-days: 7
          if-no-files-found: ignore

  # ── Codex AI Code Review (secondary) ───────────────────────────
  codex-review:
    name: Codex AI Code Review
    needs: [fork-guard, config, gemini-review]
    if: >-
      needs.config.outputs.ai-reviews-enabled == 'true' &&
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft &&
      needs.gemini-review.result != 'skipped'
    runs-on: self-hosted
    timeout-minutes: 15
    continue-on-error: true
    outputs:
      status: ${{ steps.review.outputs.status }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Run Codex review
        id: review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if ! command -v github-agents &>/dev/null; then
            echo "::warning::github-agents not found on PATH - skipping Codex review"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          set +e
          OUTPUT=$(github-agents pr-review "$PR_NUMBER" --agent codex 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT"
          echo "$OUTPUT" > codex-review.md

          if [ $EXIT_CODE -ne 0 ]; then
            if echo "$OUTPUT" | grep -qiE '429|rate.?limit|quota|resource.?exhausted'; then
              echo "::warning::Codex API rate limit hit"
              echo "status=rate_limited" >> $GITHUB_OUTPUT
              exit 0
            elif echo "$OUTPUT" | grep -qiE '503|502|service.?unavailable|ECONNREFUSED|ETIMEDOUT'; then
              echo "::warning::Codex API unavailable"
              echo "status=unavailable" >> $GITHUB_OUTPUT
              exit 0
            elif echo "$OUTPUT" | grep -qiE 'panicked at|thread.*panic'; then
              echo "::warning::Codex review tool crashed - skipping review"
              echo "status=tool_crash" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              exit $EXIT_CODE
            fi
          fi

          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload review artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-review-${{ github.run_id }}-${{ github.run_attempt }}
          path: codex-review.md
          retention-days: 7
          if-no-files-found: ignore

  # ── Agent Review Response (responds to Gemini/Codex feedback) ──
  agent-review-response:
    name: Agent Review Response
    needs: [ci, config, gemini-review, codex-review]
    if: |
      always() &&
      !cancelled() &&
      needs.config.outputs.ai-reviews-enabled == 'true' &&
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft &&
      !contains(github.event.pull_request.labels.*.name, 'no-auto-fix')
    runs-on: self-hosted
    timeout-minutes: 30
    outputs:
      made_changes: ${{ steps.agent-fix.outputs.made_changes }}
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      GITHUB_TOKEN: ${{ secrets.AGENT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false
          token: ${{ secrets.AGENT_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Ensure clean working directory
        run: |
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      - name: Check iteration count
        id: iteration
        uses: ./.github/actions/agent-iteration-check
        with:
          pr_number: ${{ github.event.pull_request.number }}
          max_iterations: '5'
          agent_type: 'review-fix'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip if max iterations reached
        if: steps.iteration.outputs.exceeded_max == 'true'
        run: |
          echo "Maximum iterations (5) reached for review-fix agent. Manual intervention required."
          echo "made_changes=false" >> $GITHUB_OUTPUT
          exit 0

      - name: Download review artifacts
        if: steps.iteration.outputs.should_skip != 'true'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: '*-review-${{ github.run_id }}-${{ github.run_attempt }}'
          merge-multiple: true
          path: .

      - name: Run agent review response
        id: agent-fix
        if: steps.iteration.outputs.should_skip != 'true'
        env:
          GEMINI_REVIEW_PATH: gemini-review.md
          CODEX_REVIEW_PATH: codex-review.md
          BRANCH_NAME: ${{ github.head_ref }}
          ITERATION_COUNT: ${{ steps.iteration.outputs.iteration_count }}
        run: |
          if ! command -v automation-cli &>/dev/null; then
            echo "::warning::automation-cli not found on PATH - skipping review response"
            echo "made_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Running agent review response..."
          automation-cli review respond \
            "$PR_NUMBER" \
            "$BRANCH_NAME" \
            "$ITERATION_COUNT" \
            "5"

  # ── Agent Failure Handler ──────────────────────────────────────
  agent-failure-handler:
    name: Agent Failure Handler
    needs: [ci, config, gemini-review, codex-review, agent-review-response]
    if: |
      failure() &&
      needs.config.outputs.ai-reviews-enabled == 'true' &&
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft &&
      !contains(github.event.pull_request.labels.*.name, 'no-auto-fix') &&
      needs.ci.result == 'failure'
    runs-on: self-hosted
    timeout-minutes: 30
    outputs:
      made_changes: ${{ steps.agent-fix.outputs.made_changes }}
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      GITHUB_TOKEN: ${{ secrets.AGENT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          for item in outputs .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false
          token: ${{ secrets.AGENT_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Ensure clean working directory
        run: |
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      - name: Check iteration count
        id: iteration
        uses: ./.github/actions/agent-iteration-check
        with:
          pr_number: ${{ github.event.pull_request.number }}
          max_iterations: '5'
          agent_type: 'failure-fix'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip if max iterations reached
        if: steps.iteration.outputs.exceeded_max == 'true'
        run: |
          echo "Maximum iterations (5) reached for failure-fix agent. Manual intervention required."
          echo "made_changes=false" >> $GITHUB_OUTPUT
          exit 0

      - name: Run agent failure handler
        id: agent-fix
        if: steps.iteration.outputs.exceeded_max != 'true'
        env:
          BRANCH_NAME: ${{ github.head_ref }}
          ITERATION_COUNT: ${{ steps.iteration.outputs.iteration_count }}
        run: |
          if ! command -v automation-cli &>/dev/null; then
            echo "::warning::automation-cli not found on PATH - skipping failure handler"
            echo "made_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Running agent failure handler..."
          automation-cli review failure \
            "$PR_NUMBER" \
            "$BRANCH_NAME" \
            "$ITERATION_COUNT" \
            "5" \
            "format,lint,test"

  # ── PR Status Summary ──────────────────────────────────────────
  pr-status:
    name: PR Status Summary
    needs: [ci, config, browser-tests, gemini-review, codex-review, agent-review-response, agent-failure-handler]
    if: always()
    runs-on: self-hosted
    steps:
      - name: Generate status summary
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CI | ${{ needs.ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser Tests | ${{ needs.browser-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gemini Review | ${{ needs.gemini-review.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Codex Review | ${{ needs.codex-review.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Review Response | ${{ needs.agent-review-response.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failure Handler | ${{ needs.agent-failure-handler.result }} |" >> $GITHUB_STEP_SUMMARY

          # CI failure is blocking; browser tests are advisory
          if [[ "${{ needs.ci.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "CI failed - please review the logs" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR validation completed successfully" >> $GITHUB_STEP_SUMMARY
